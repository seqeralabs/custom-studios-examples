
# Learn more: https://docs.posit.co/ide/server-pro/admin/access_and_security/running_with_a_proxy.html

events {
}

http {

    # Support proxying of web-socket connections
    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }

    server {
        listen ${NGINX_PORT};

        location ${CONNECT_TOOL_PATH_PREFIX} {

            rewrite ^${CONNECT_TOOL_PATH_PREFIX}(.*)$ /$1 break;

            proxy_pass http://localhost:${CONNECT_TOOL_PORT};

            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
            proxy_read_timeout 20d;

            proxy_set_header X-RStudio-Root-Path ${CONNECT_TOOL_PATH_PREFIX};

            proxy_set_header Host $host:$server_port;
        }
    }

}
